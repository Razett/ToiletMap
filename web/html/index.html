<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="~{/base/base::setContent(~{this::head}, ~{this::content}, ~{this::script})}">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>ToiletMap</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
        <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
    </head>
    <body>
    <!-- Navbar Top Title -->
    <th:block th:fragment="head">

    </th:block>

    <!-- Main Content -->
    <th:block th:fragment="content">
        <button type="button" class="location-refresh" onclick="resetCenter()">
            <i class="fa-solid fa-location-crosshairs"></i>
        </button>
        <div class="map-index" id="map"></div>
        <div class="floating-list" id="floating-list">
            <div class="drag-handle">
                <div></div>
            </div>
            <div class="title-area">
                <h3 class="title">저장된 주변 장소</h3>
                <button class="close d-none" data-tab="tab-search" onclick="clearSearchList()">
                    <span>X</span>
                </button>
            </div>
            <span class="search-count c-grey-800">{GeoLocation}</span>
            <div class="floating-list-inner" >
                <div class="list" id="tab-list"></div>
                <div class="list" id="tab-search"></div>
            </div>
        </div>

        <!-- Modal -->
        <div class="modal fade" id="add-toilet-modal" tabindex="-1" aria-labelledby="add-toilet-info" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="d-flex align-items-center gap-2 mb-1">
                            <i class="fa-solid fa-location-dot"></i>
                                <h4 class="place-name">장소 명</h4>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <span class="d-inline-block mb-3">이 장소에 화장실 정보를 추가합니다.</span>
                        <div class="d-flex gap-3 mb-4">
                            <div class="section">
                                <div class="mb-1">
                                    <span class="c-blue-800 gender-section-title">남자</span>
                                </div>
                                <div class="d-flex align-items-center gap-3 mb-2">
                                    <i class="fa-solid fa-hashtag"></i>
                                    <label for="add-toilet-man-password" class="d-none">비밀번호</label>
                                    <input type="number" name="man-password" id="add-toilet-man-password" class="form-control toilet-key bgc-grey-50" placeholder="0000" maxlength="10">
                                </div>
                                <div class="d-flex align-items-center justify-content-between gap-2">
                                    <div>
                                        <i class="fa-solid fa-key"></i>
                                        <span class="ms-2">필수 여부</span>
                                    </div>
                                    <div class="form-check form-switch add-toilet-key">
                                        <input type="checkbox" role="switch" class="form-check-input" id="add-toilet-man-needkey" onchange="toggleAddToiletPassword(this)">
                                    </div>
                                </div>
                            </div>
                            <div class="section">
                                <div class="mb-1">
                                    <span class="c-red-800 gender-section-title">여자</span>
                                </div>
                                <div class="d-flex align-items-center gap-3 mb-2">
                                    <i class="fa-solid fa-hashtag"></i>
                                    <label for="add-toilet-man-password" class="d-none">비밀번호</label>
                                    <input type="number" name="woman-password" id="add-toilet-woman-password" class="form-control toilet-key bgc-grey-50" placeholder="0000" maxlength="10">
                                </div>
                                <div class="d-flex align-items-center justify-content-between gap-2">
                                    <div>
                                        <i class="fa-solid fa-key"></i>
                                        <span class="ms-2">필수 여부</span>
                                    </div>
                                    <div class="form-check form-switch add-toilet-key">
                                        <input type="checkbox" role="switch" class="form-check-input" id="add-toilet-woman-needkey" onchange="toggleAddToiletPassword(this)">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex align-items-center justify-content-between gap-3 mb-3">
                            <div>
                                <i class="fa-solid fa-stairs"></i>
                                <span class="ms-2">층</span>
                            </div>
                            <input type="number" name="floor" class="form-control add-toilet-floor bgc-grey-50" id="add-toilet-floor" placeholder="1" maxlength="2">
                        </div>
                        <div class="align-items-center justify-content-between mb-3">
                            <div class="d-flex align-items-center gap-2 mb-1">
                                <i class="fa-solid fa-pen"></i>
                                <span class="ms-2">메모</span>
                            </div>
                            <textarea class="form-control bgc-grey-50 border-0" name="memo" id="add-toilet-memo"></textarea>
                        </div>
                        <input type="hidden" name="place-id" id="add-toilet-place-id">
                        <input type="hidden" name="place-id" id="add-toilet-place-address">
                        <input type="hidden" name="place-id" id="add-toilet-place-lat">
                        <input type="hidden" name="place-id" id="add-toilet-place-lng">
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                        <button type="button" class="btn btn-primary" onclick="addToilet()">추가</button>
                    </div>
                </div>
            </div>
        </div>
    </th:block>

    <th:block th:fragment="script">
        <script src="../js/place.js"></script>
        <script src="../js/location.js"></script>
        <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=rkzrjlm2t4"></script>
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                getGeoLocation().then(location => {
                    _geo_lat = location.lat;
                    _geo_lng = location.lng;
                    _geo_type = location.type;

                    const mapOptions = {
                        center: new naver.maps.LatLng(location.lat, location.lng),
                        zoom: 16
                    };

                    reverseGeocoding(_geo_lat, _geo_lng, function (data) {
                        document.querySelector('.search-count').innerText = _current_location_address;
                    });

                    map = new naver.maps.Map(document.getElementById('map'), mapOptions);

                    getNearbyToilet();
                    console.log(markers_saved);

                    naver.maps.Event.addListener(map, 'idle', function() {
                        updateMarkers(map, markers);
                        updateMarkers(map, markers_saved);
                    });

                    _current_location_marker = new naver.maps.Marker({
                        position: new naver.maps.LatLng(_geo_lat, _geo_lng),
                        map: map,
                        icon: {
                            url: './asset/image/marker/marker-red.png',
                            size: new naver.maps.Size(25, 34),
                            scaledSize: new naver.maps.Size(25, 34),
                            origin: new naver.maps.Point(0, 0),
                            anchor: new naver.maps.Point(12, 34)
                        }
                    });

                }).catch(error => {
                    map = new naver.maps.Map(document.getElementById('map'));

                    naver.maps.Event.addListener(map, 'idle', function() {
                        updateMarkers(map, markers);
                        updateMarkers(map, markers_saved);
                    });
                });

                const addToiletModal = document.querySelector('#add-toilet-modal');

                if (addToiletModal) {
                    addToiletModal.addEventListener('hide.bs.modal', () => {
                        clearAddToiletModal();
                    })
                }

                // floating list infinite scroll
                $('.floating-list-inner').on('scroll', function () {
                    const container = $(this);
                    const scrollTop = container.scrollTop();
                    const scrollHeight = container[0].scrollHeight;
                    const containerHeight = container.outerHeight();

                    const distanceFromBottom = scrollHeight - (scrollTop + containerHeight);

                    const is_searching = $('.floating-list #tab-list').hasClass('d-none');

                    if (distanceFromBottom < 50) {
                        if (is_searching) {
                            if (_search_get_continue && !_search_is_fetching) {
                                search_place_ajax();
                            }
                        } else {
                            if (_nearby_toilet_get_continue && !_search_is_fetching) {
                                getNearbyToilet();
                            }
                        }
                    }
                });
            });
        </script>
    </th:block>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    </body>
</th:block>
</html>